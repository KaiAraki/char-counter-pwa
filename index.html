<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>文字アドベンチャーラボ</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#f6f6f6">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --bg-gradient: linear-gradient(135deg, #b1c8ff 0%, #f7d4f5 48%, #fff5c2 100%);
      --surface: rgba(255, 255, 255, 0.78);
      --surface-strong: rgba(255, 255, 255, 0.92);
      --border: rgba(255, 255, 255, 0.45);
      --text-main: #2c2c30;
      --text-sub: #4f4f57;
      --accent: #5b63ff;
      --accent-dark: #3c3fca;
      --shadow: 0 25px 45px rgba(38, 45, 74, 0.15);
      --radius-lg: 26px;
      --radius-md: 18px;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: "Noto Sans JP", "Hiragino Sans", "ヒラギノ角ゴ ProN", "Yu Gothic", YuGothic, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      line-height: 1.7;
      min-height: 100vh;
      background: var(--bg-gradient);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: clamp(24px, 5vw, 48px);
      padding-bottom: clamp(120px, 22vh, 160px);
      position: relative;
      overflow: hidden;
    }
    body::before,
    body::after {
      content: "";
      position: fixed;
      inset: -30%;
      z-index: -1;
      pointer-events: none;
      background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.8), transparent 55%),
        radial-gradient(circle at 80% 30%, rgba(255, 184, 255, 0.7), transparent 60%),
        radial-gradient(circle at 40% 80%, rgba(165, 194, 255, 0.7), transparent 60%);
      filter: blur(60px);
      opacity: 0.65;
      animation: aurora-flow 36s linear infinite;
      transform-origin: center;
    }
    body::after {
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.75), transparent 55%),
        radial-gradient(circle at 70% 60%, rgba(255, 240, 200, 0.6), transparent 60%),
        radial-gradient(circle at 60% 20%, rgba(180, 255, 236, 0.5), transparent 65%);
      filter: blur(80px);
      opacity: 0.55;
      animation-duration: 48s;
      animation-direction: reverse;
    }
    @keyframes aurora-flow {
      0% {
        transform: translate3d(-4%, -4%, 0) rotate(0deg) scale(1.05);
      }
      50% {
        transform: translate3d(4%, 3%, 0) rotate(180deg) scale(1.1);
      }
      100% {
        transform: translate3d(-4%, -4%, 0) rotate(360deg) scale(1.05);
      }
    }
    .wrap {
      width: min(960px, 100%);
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: clamp(24px, 4vw, 48px);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }
    [data-view] {
      display: none;
    }
    [data-view].is-active {
      display: block;
    }
    header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: clamp(20px, 4vw, 36px);
    }
    .headline {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: clamp(1.2rem, 4vw, 1.8rem);
      font-weight: 700;
      letter-spacing: 0.05em;
    }
    .headline-icon {
      width: clamp(38px, 6vw, 52px);
      height: clamp(38px, 6vw, 52px);
      display: grid;
      place-items: center;
      border-radius: 16px;
      background: var(--surface-strong);
      box-shadow: 0 12px 25px rgba(91, 99, 255, 0.15);
      color: var(--accent);
    }
    .headline small {
      display: block;
      font-size: clamp(0.65rem, 2.1vw, 0.78rem);
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--accent);
    }
    header p {
      margin: 0;
      color: var(--text-sub);
      font-size: clamp(0.92rem, 2.6vw, 1.05rem);
    }
    .mascot {
      display: flex;
      align-items: center;
      gap: clamp(16px, 4vw, 28px);
      padding: clamp(16px, 3vw, 24px);
      margin-bottom: clamp(18px, 3.4vw, 30px);
      background: rgba(255, 255, 255, 0.88);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      position: relative;
      overflow: hidden;
    }
    .mascot::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top right, rgba(91, 99, 255, 0.18), transparent 60%);
    }
    .mascot-figure {
      position: relative;
      display: grid;
      place-items: center;
      width: clamp(70px, 14vw, 90px);
      height: clamp(70px, 14vw, 90px);
      border-radius: 24px;
      background: linear-gradient(135deg, #fff 0%, #f0f3ff 100%);
      border: 1px solid rgba(91, 99, 255, 0.25);
      box-shadow: 0 18px 24px rgba(59, 63, 204, 0.18);
    }
    .mascot-face {
      width: 78%;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease;
    }
    .mascot-face img {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: contain;
    }
    .mascot-hand {
      position: absolute;
      bottom: clamp(10px, 2vw, 16px);
      right: clamp(10px, 2vw, 16px);
      width: clamp(24px, 4vw, 28px);
      height: clamp(24px, 4vw, 28px);
      border-radius: 50% 50% 45% 45%;
      background: #ffd9ef;
      box-shadow: inset -3px -5px 0 rgba(255, 176, 216, 0.6);
      transform-origin: top right;
    }
    .mascot-message {
      flex: 1;
      margin: 0;
      color: var(--text-sub);
      font-size: clamp(0.95rem, 3vw, 1.05rem);
      line-height: 1.6;
    }
    .mascot.is-animate .mascot-face {
      animation: mascot-bounce 0.7s ease;
    }
    .mascot.is-animate .mascot-hand {
      animation: mascot-wave 0.7s ease;
    }
    @keyframes mascot-bounce {
      0% { transform: translateY(0) scale(1); }
      30% { transform: translateY(-6px) scale(1.05); }
      60% { transform: translateY(2px) scale(0.98); }
      100% { transform: translateY(0) scale(1); }
    }
    @keyframes mascot-wave {
      0% { transform: rotate(0deg); }
      35% { transform: rotate(-18deg); }
      70% { transform: rotate(12deg); }
      100% { transform: rotate(0deg); }
    }
    textarea {
      width: 100%;
      min-height: clamp(260px, 45vh, 480px);
      padding: clamp(16px, 3.8vw, 22px);
      font-size: clamp(1rem, 3.3vw, 1.08rem);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--surface-strong);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.45);
      resize: vertical;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }
    textarea:focus {
      outline: none;
      border-color: rgba(91, 99, 255, 0.6);
      box-shadow: 0 0 0 4px rgba(91, 99, 255, 0.18);
    }
    textarea::placeholder {
      color: rgba(79, 79, 87, 0.55);
    }
    .stats {
      display: grid;
      gap: clamp(14px, 2.4vw, 20px);
      margin: clamp(18px, 3vw, 28px) 0;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
    .box {
      padding: clamp(14px, 2.6vw, 20px);
      border-radius: var(--radius-md);
      background: var(--surface-strong);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(38, 45, 74, 0.08);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .box::after {
      content: "";
      position: absolute;
      inset: -60% 60% 60% -60%;
      background: radial-gradient(circle at top left, rgba(91, 99, 255, 0.18), transparent 60%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    .box:hover::after {
      opacity: 1;
    }
    @supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))) {
      .wrap {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.92), rgba(255, 255, 255, 0.78));
      }
      .box {
        background: linear-gradient(140deg, rgba(255, 255, 255, 0.98), rgba(246, 248, 255, 0.82));
      }
    }
    .box strong {
      display: block;
      font-size: clamp(1.4rem, 4vw, 1.8rem);
      margin-top: 6px;
      letter-spacing: 0.03em;
    }
    .box span {
      display: block;
      color: var(--text-sub);
      font-size: 0.92rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: flex-end;
    }
    button {
      padding: 12px 22px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent) 0%, #7a7fff 100%);
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 18px 30px rgba(91, 99, 255, 0.25);
      transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 24px 36px rgba(60, 63, 202, 0.28);
      filter: brightness(1.05);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 14px 20px rgba(60, 63, 202, 0.22);
    }
    footer {
      margin-top: clamp(24px, 4vw, 40px);
      color: var(--text-sub);
      font-size: clamp(0.85rem, 2.8vw, 0.96rem);
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .badge {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(91, 99, 255, 0.12);
      color: var(--accent);
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .global-nav {
      position: fixed;
      left: 50%;
      bottom: clamp(16px, 5vw, 32px);
      transform: translateX(-50%);
      width: min(640px, calc(100% - clamp(24px, 10vw, 80px)));
      z-index: 20;
    }
    .global-nav-inner {
      display: flex;
      gap: 12px;
      padding: 14px;
      border-radius: 999px;
      background: rgba(15, 14, 43, 0.18);
      box-shadow: 0 25px 45px rgba(24, 27, 58, 0.16);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.22);
    }
    .nav-button {
      flex: 1;
      border: none;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.55);
      color: var(--text-main);
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 12px 16px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease, color 0.18s ease;
    }
    .nav-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 26px rgba(56, 63, 146, 0.22);
    }
    .nav-button.is-active {
      background: linear-gradient(135deg, #5b63ff 0%, #ff8ade 100%);
      color: #fff;
      box-shadow: 0 18px 32px rgba(91, 99, 255, 0.35);
    }
    .nav-button span {
      font-size: 0.72rem;
      letter-spacing: 0.18em;
    }
    .nav-button strong {
      font-size: 0.96rem;
      letter-spacing: 0.08em;
    }
    .nav-icon {
      width: 28px;
      height: 28px;
      display: grid;
      place-items: center;
    }
    .game-layout {
      display: grid;
      gap: clamp(20px, 3.6vw, 32px);
      align-items: start;
    }
    .game-canvas-wrap {
      position: relative;
      border-radius: var(--radius-md);
      padding: clamp(18px, 3vw, 26px);
      background: rgba(17, 22, 58, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 0 25px 45px rgba(26, 22, 66, 0.28);
    }
    #game-board {
      width: 100%;
      height: auto;
      display: block;
      background: rgba(8, 9, 30, 0.92);
      border-radius: 12px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.12);
      image-rendering: pixelated;
    }
    .game-info {
      display: grid;
      gap: clamp(16px, 3vw, 24px);
    }
    .game-scoreboard {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
    .game-scoreboard .box {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 18px 32px rgba(28, 30, 82, 0.18);
    }
    .game-banner {
      margin: 0;
      padding: 14px 18px;
      border-radius: var(--radius-md);
      background: rgba(91, 99, 255, 0.12);
      color: var(--accent-dark);
      font-weight: 600;
    }
    .game-instruction {
      margin: 0;
      color: var(--text-sub);
      font-size: 0.92rem;
    }
    @media (max-width: 640px) {
      body {
        padding: clamp(18px, 8vw, 32px);
        padding-bottom: clamp(120px, 30vw, 220px);
      }
      .wrap {
        padding: clamp(18px, 6vw, 32px);
      }
      .actions {
        justify-content: stretch;
      }
      button {
        width: 100%;
        justify-content: center;
      }
      .global-nav-inner {
        gap: 8px;
        padding: 12px;
      }
      .nav-button {
        padding: 10px 12px;
      }
    }
    @media (min-width: 860px) {
      .game-layout {
        grid-template-columns: minmax(0, 0.95fr) minmax(220px, 0.85fr);
      }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="view is-active" data-view="counter" aria-labelledby="counter-title">
      <header>
        <div class="headline">
          <span class="headline-icon" aria-hidden="true">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 3L4 7V17L12 21L20 17V7L12 3Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
              <path d="M9 9H15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M9 12H15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              <path d="M9 15H13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </span>
          <div id="counter-title">
            <small>Word Party</small>
            文字カウント・ショータイム
          </div>
        </div>
        <p>文章づくりを盛り上げるステージへようこそ！リアルタイムで文字数・行数・単語数を測りながら、あなたのストーリーをノリノリに仕上げましょう。</p>
      </header>

      <section class="mascot" aria-live="polite">
        <div class="mascot-figure">
          <div class="mascot-face">
            <img id="mascot-face" src="assets/reaction-waiting.svg" alt="わくわくして入力を待つ表情">
          </div>
          <div class="mascot-hand"></div>
        </div>
        <p class="mascot-message" id="mascot-message">ステージは整ったよ！どんな文章で盛り上げる？</p>
      </section>

      <textarea id="t" placeholder="ここに文章を投げ込んで、言葉のショーを始めよう！"></textarea>

      <div class="stats" aria-live="polite">
        <div class="box">
          <span>Character</span>
          <strong id="chars">0</strong>
        </div>
        <div class="box">
          <span>Lines</span>
          <strong id="lines">0</strong>
        </div>
        <div class="box">
          <span>Words</span>
          <strong id="words">0</strong>
        </div>
      </div>

      <div class="actions">
        <button id="clear" type="button">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M3 6H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M9 6V4H15V6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 11V17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M14 11V17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M5 6L6 19C6.05535 19.5978 6.31954 20.1599 6.75041 20.58C7.18128 21.0002 7.75022 21.25 8.343 21.29H15.657C16.20498 21.25 16.8187 21.0002 17.2496 20.58C17.6805 20.1599 17.9447 19.5978 18 19L19 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          クリア
        </button>
      </div>

      <footer>
        <span class="badge">PWA Ready</span>
        オフラインでも利用OK。ホーム画面に置けば、いつでもどこでも文字ライブを楽しめます。
      </footer>
    </section>

    <section class="view" data-view="game" aria-labelledby="game-title">
      <header>
        <div class="headline">
          <span class="headline-icon" aria-hidden="true">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="4" width="18" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/>
              <path d="M8 18L10 16H14L16 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="9" cy="10" r="1" fill="currentColor"/>
              <circle cx="15" cy="10" r="1" fill="currentColor"/>
            </svg>
          </span>
          <div id="game-title">
            <small>Arcade Time</small>
            ポップドロップ・パズル
          </div>
        </div>
        <p>キラキラ降るブロックをさばいてハイスコアを狙う、ライトなテトリス風ミニゲーム。文章制作のクールダウンに、ちょっとしたエンタメタイムをどうぞ！</p>
      </header>

      <div class="game-layout">
        <div class="game-canvas-wrap">
          <canvas id="game-board" width="240" height="432" aria-describedby="game-banner"></canvas>
        </div>
        <div class="game-info">
          <p class="game-banner" id="game-banner">ゲームスタートを押して、ブロックショーを開演しよう！</p>
          <div class="game-scoreboard">
            <div class="box">
              <span>Score</span>
              <strong id="game-score">0</strong>
            </div>
            <div class="box">
              <span>Lines</span>
              <strong id="game-lines">0</strong>
            </div>
            <div class="box">
              <span>Level</span>
              <strong id="game-level">1</strong>
            </div>
          </div>
          <p class="game-instruction">矢印キーで移動＆回転（上キー）。スペースキーで一気にドロップ！音は出ないので静かな場所でも安心です。</p>
          <button id="game-start" type="button">ゲームスタート／リスタート</button>
        </div>
      </div>
    </section>
  </main>

  <nav class="global-nav" aria-label="メインメニュー">
    <div class="global-nav-inner">
      <button class="nav-button is-active" type="button" data-nav="counter" aria-pressed="true">
        <div class="nav-icon" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 7H20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M6 12H18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M9 17H15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>
        <strong>文字カウンター</strong>
        <span>Count</span>
      </button>
      <button class="nav-button" type="button" data-nav="game" aria-pressed="false">
        <div class="nav-icon" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="4" y="4" width="7" height="7" rx="1.2" fill="currentColor"/>
            <rect x="13" y="4" width="7" height="9" rx="1.2" stroke="currentColor" stroke-width="1.5"/>
            <rect x="4" y="13" width="7" height="7" rx="1.2" stroke="currentColor" stroke-width="1.5"/>
            <rect x="13" y="15" width="7" height="5" rx="1.2" fill="currentColor"/>
          </svg>
        </div>
        <strong>ゲーム</strong>
        <span>Arcade</span>
      </button>
    </div>
  </nav>

  <script>
    const $ = s => document.querySelector(s);
    const t = $('#t'), chars = $('#chars'), lines = $('#lines'), words = $('#words');
    const mascot = $('.mascot');
    const mascotFace = $('#mascot-face');
    const mascotMessage = $('#mascot-message');
    const defaultReaction = {
      src: 'assets/reaction-waiting.svg',
      alt: 'わくわくして入力を待つ表情',
      message: 'ステージは整ったよ！どんな文章で盛り上げる？'
    };
    const reactions = [
      {
        src: 'assets/reaction-happy.svg',
        alt: '嬉しそうに微笑む表情',
        message: 'リズム最高！そのままビート刻んで！'
      },
      {
        src: 'assets/reaction-energetic.svg',
        alt: '勢いづいてやる気に満ちた表情',
        message: '勢いが出てきたよ！このままクライマックスへ！'
      },
      {
        src: 'assets/reaction-surprised.svg',
        alt: '驚いて目を丸くする表情',
        message: 'わぁ、キラーワードの雨が降ってる〜！'
      },
      {
        src: 'assets/reaction-calm.svg',
        alt: '穏やかに見守る表情',
        message: '深呼吸してステージを丁寧に整えよう。'
      },
      {
        src: 'assets/reaction-hopeful.svg',
        alt: '希望に満ちた微笑みの表情',
        message: 'あとちょっとでフィナーレの予感だよ〜！'
      }
    ];
    let previousReactionIndex = -1;

    function setReaction(reaction) {
      if (!mascotFace || !mascotMessage) return;
      mascotFace.setAttribute('src', reaction.src);
      mascotFace.setAttribute('alt', reaction.alt);
      mascotMessage.textContent = reaction.message;
    }

    function playReaction(text){
      if (!mascot || !mascotFace || !mascotMessage) return;
      if (!text.trim()) {
        setReaction(defaultReaction);
      } else {
        let nextIndex = Math.floor(Math.random() * reactions.length);
        if (reactions.length > 1) {
          while (nextIndex === previousReactionIndex) {
            nextIndex = Math.floor(Math.random() * reactions.length);
          }
        }
        previousReactionIndex = nextIndex;
        const reaction = reactions[nextIndex];
        setReaction(reaction);
      }
      mascot.classList.remove('is-animate');
      void mascot.offsetWidth; // reflow to restart animation
      mascot.classList.add('is-animate');
    }

    function update(triggerAnimation = false){
      const v = t.value;
      chars.textContent = [...v].length; // サロゲート対策
      lines.textContent = v === '' ? 0 : v.split(/\r\n|\r|\n/).length;
      const w = v.trim().split(/\s+/).filter(Boolean);
      words.textContent = v.trim() ? w.length : 0;
      localStorage.setItem('text', v); // 直近内容を保持
      if (triggerAnimation) {
        playReaction(v);
      }
    }
    t.addEventListener('input', ()=> update(true));
    $('#clear').addEventListener('click', ()=>{ t.value=''; update(true); });

    // 前回の内容を復元
    t.value = localStorage.getItem('text') || '';
    update();
    if (t.value) {
      playReaction(t.value);
    } else {
      setReaction(defaultReaction);
    }

    const views = document.querySelectorAll('[data-view]');
    const navButtons = document.querySelectorAll('[data-nav]');
    let currentView = 'counter';
    const activeView = document.querySelector('[data-view].is-active');
    if (activeView) {
      currentView = activeView.dataset.view;
    }
    views.forEach(view => {
      const isActive = view.dataset.view === currentView;
      view.hidden = !isActive;
      view.classList.toggle('is-active', isActive);
    });
    navButtons.forEach(btn => {
      const isActive = btn.dataset.nav === currentView;
      btn.classList.toggle('is-active', isActive);
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });

    const canvas = document.getElementById('game-board');
    const ctx = canvas ? canvas.getContext('2d') : null;
    const gameScoreEl = $('#game-score');
    const gameLinesEl = $('#game-lines');
    const gameLevelEl = $('#game-level');
    const gameBanner = $('#game-banner');
    const gameStartButton = $('#game-start');

    const COLS = 10;
    const ROWS = 18;
    const BLOCK_SIZE = 24;
    const COLORS = [null, '#7f7bff', '#ff5db2', '#ffb347', '#66f0c5', '#50c9ff', '#c7a2ff', '#ffe066'];
    const arena = createMatrix(ROWS, COLS);
    const player = { pos: { x: 0, y: 0 }, matrix: null, score: 0, lines: 0, level: 1 };
    let dropInterval = 800;
    let dropTimer = null;
    let isGameRunning = false;
    let isGameOver = false;
    let hasGameStarted = false;

    function setBanner(message) {
      if (gameBanner) {
        gameBanner.textContent = message;
      }
    }

    function updateScoreboard() {
      if (gameScoreEl) gameScoreEl.textContent = player.score;
      if (gameLinesEl) gameLinesEl.textContent = player.lines;
      if (gameLevelEl) gameLevelEl.textContent = player.level;
    }

    function createMatrix(rows, cols) {
      return Array.from({ length: rows }, () => Array(cols).fill(0));
    }

    function createPiece(type) {
      switch (type) {
        case 'T':
          return [
            [0, 1, 0],
            [1, 1, 1],
            [0, 0, 0],
          ];
        case 'O':
          return [
            [2, 2],
            [2, 2],
          ];
        case 'L':
          return [
            [0, 0, 3],
            [3, 3, 3],
            [0, 0, 0],
          ];
        case 'J':
          return [
            [4, 0, 0],
            [4, 4, 4],
            [0, 0, 0],
          ];
        case 'S':
          return [
            [0, 5, 5],
            [5, 5, 0],
            [0, 0, 0],
          ];
        case 'Z':
          return [
            [6, 6, 0],
            [0, 6, 6],
            [0, 0, 0],
          ];
        case 'I':
          return [
            [0, 0, 0, 0],
            [7, 7, 7, 7],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
          ];
        default:
          return [[1]];
      }
    }

    function drawMatrix(matrix, offset) {
      if (!ctx) return;
      matrix.forEach((row, y) => {
        row.forEach((value, x) => {
          if (value !== 0) {
            ctx.fillStyle = COLORS[value] || '#ffffff';
            ctx.fillRect((x + offset.x) * BLOCK_SIZE, (y + offset.y) * BLOCK_SIZE, BLOCK_SIZE - 1, BLOCK_SIZE - 1);
          }
        });
      });
    }

    function draw() {
      if (!ctx || !canvas) return;
      ctx.fillStyle = 'rgba(8, 9, 30, 1)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      drawMatrix(arena, { x: 0, y: 0 });
      if (player.matrix) {
        drawMatrix(player.matrix, player.pos);
      }
    }

    function merge(arena, player) {
      player.matrix.forEach((row, y) => {
        row.forEach((value, x) => {
          if (value !== 0) {
            arena[y + player.pos.y][x + player.pos.x] = value;
          }
        });
      });
    }

    function collide(arena, player) {
      for (let y = 0; y < player.matrix.length; y++) {
        for (let x = 0; x < player.matrix[y].length; x++) {
          if (player.matrix[y][x] !== 0) {
            const row = arena[y + player.pos.y];
            if (!row || row[x + player.pos.x] !== 0) {
              return true;
            }
          }
        }
      }
      return false;
    }

    function rotate(matrix, dir) {
      for (let y = 0; y < matrix.length; y++) {
        for (let x = 0; x < y; x++) {
          [matrix[x][y], matrix[y][x]] = [matrix[y][x], matrix[x][y]];
        }
      }
      if (dir > 0) {
        matrix.forEach(row => row.reverse());
      } else {
        matrix.reverse();
      }
    }

    function arenaSweep() {
      let rowCount = 0;
      for (let y = arena.length - 1; y >= 0; y--) {
        if (arena[y].every(value => value !== 0)) {
          arena.splice(y, 1);
          arena.unshift(new Array(COLS).fill(0));
          rowCount++;
          y++;
        }
      }
      if (rowCount > 0) {
        player.score += rowCount * rowCount * 120 * player.level;
        player.lines += rowCount;
        if (rowCount >= 4) {
          setBanner('テトリス成功！会場がどよめいてるよ！');
        } else if (rowCount > 1) {
          setBanner(`${rowCount}ラインコンボ！リズムに乗ってる！`);
        } else {
          setBanner('1ラインクリア！いい流れだね！');
        }
        if (player.lines >= player.level * 8) {
          player.level++;
          dropInterval = Math.max(150, dropInterval - 70);
          if (isGameRunning && !isGameOver) {
            restartDropTimer();
            setBanner(`レベル${player.level}にアップ！スピード注意！`);
          }
        }
        updateScoreboard();
      }
    }

    function restartDropTimer() {
      stopDropTimer();
      if (isGameRunning && !isGameOver) {
        dropTimer = setInterval(playerDrop, dropInterval);
      }
    }

    function stopDropTimer() {
      if (dropTimer) {
        clearInterval(dropTimer);
        dropTimer = null;
      }
    }

    function playerReset() {
      if (!canvas || !ctx) return;
      const pieces = 'TJLOSZI';
      const type = pieces[Math.floor(Math.random() * pieces.length)];
      player.matrix = createPiece(type);
      player.pos.y = 0;
      player.pos.x = Math.floor((COLS - player.matrix[0].length) / 2);
      if (collide(arena, player)) {
        isGameOver = true;
        isGameRunning = false;
        setBanner('ゲームオーバー！ゲームスタートで再挑戦してね。');
        stopDropTimer();
        player.matrix = null;
      }
    }

    function playerDrop() {
      if (!isGameRunning || isGameOver) return;
      player.pos.y++;
      if (collide(arena, player)) {
        player.pos.y--;
        merge(arena, player);
        arenaSweep();
        playerReset();
      }
      draw();
    }

    function hardDrop() {
      if (!isGameRunning || isGameOver) return;
      while (!collide(arena, player)) {
        player.pos.y++;
      }
      player.pos.y--;
      merge(arena, player);
      arenaSweep();
      playerReset();
      draw();
      if (!isGameOver) {
        restartDropTimer();
      }
    }

    function playerMove(dir) {
      if (!isGameRunning || isGameOver) return;
      player.pos.x += dir;
      if (collide(arena, player)) {
        player.pos.x -= dir;
      } else {
        draw();
      }
    }

    function playerRotate(dir) {
      if (!isGameRunning || isGameOver) return;
      const pos = player.pos.x;
      let offset = 1;
      rotate(player.matrix, dir);
      while (collide(arena, player)) {
        player.pos.x += offset;
        offset = -(offset + (offset > 0 ? 1 : -1));
        if (offset > player.matrix[0].length) {
          rotate(player.matrix, -dir);
          player.pos.x = pos;
          return;
        }
      }
      draw();
    }

    function startGame() {
      if (!canvas || !ctx) return;
      stopDropTimer();
      arena.forEach(row => row.fill(0));
      player.score = 0;
      player.lines = 0;
      player.level = 1;
      dropInterval = 800;
      isGameOver = false;
      isGameRunning = true;
      hasGameStarted = true;
      player.matrix = null;
      updateScoreboard();
      setBanner('ブロックショー開演！矢印キーで操作してね。');
      playerReset();
      if (!isGameOver) {
        draw();
        restartDropTimer();
      } else {
        draw();
      }
    }

    function pauseGame() {
      if (!hasGameStarted || isGameOver) {
        isGameRunning = false;
        stopDropTimer();
        return;
      }
      if (!isGameRunning) return;
      isGameRunning = false;
      stopDropTimer();
      setBanner('ポーズ中。ゲームメニューで再開しよう！');
    }

    function resumeGame() {
      if (!hasGameStarted || isGameOver) return;
      if (isGameRunning) return;
      isGameRunning = true;
      setBanner('再開！ブロックの雨をさばいてね！');
      restartDropTimer();
    }

    function handleGameKey(event) {
      if (currentView !== 'game' || !hasGameStarted || isGameOver) return;
      if (!isGameRunning) return;
      const key = event.key;
      if (key === 'ArrowLeft') {
        event.preventDefault();
        playerMove(-1);
      } else if (key === 'ArrowRight') {
        event.preventDefault();
        playerMove(1);
      } else if (key === 'ArrowDown') {
        event.preventDefault();
        playerDrop();
      } else if (key === 'ArrowUp') {
        event.preventDefault();
        playerRotate(1);
      } else if (key === ' ' || key === 'Spacebar') {
        event.preventDefault();
        hardDrop();
      }
    }

    function switchView(target) {
      if (!target) return;
      if (target === currentView) {
        if (target === 'game' && hasGameStarted && !isGameOver) {
          resumeGame();
        }
        return;
      }
      currentView = target;
      views.forEach(view => {
        const isActive = view.dataset.view === target;
        view.classList.toggle('is-active', isActive);
        view.hidden = !isActive;
      });
      navButtons.forEach(btn => {
        const isActive = btn.dataset.nav === target;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
      if (target === 'game') {
        if (!hasGameStarted) {
          startGame();
        } else if (!isGameOver) {
          resumeGame();
        } else {
          setBanner('ゲームオーバー！ゲームスタートで再挑戦してね。');
        }
      } else {
        pauseGame();
      }
    }

    navButtons.forEach(btn => {
      btn.addEventListener('click', () => switchView(btn.dataset.nav));
    });
    if (gameStartButton) {
      gameStartButton.addEventListener('click', () => {
        startGame();
        if (currentView !== 'game') {
          switchView('game');
        }
      });
    }
    document.addEventListener('keydown', handleGameKey);
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && currentView === 'game') {
        pauseGame();
      } else if (!document.hidden && currentView === 'game' && hasGameStarted && !isGameOver) {
        resumeGame();
      }
    });

    updateScoreboard();
    if (ctx && canvas) {
      ctx.imageSmoothingEnabled = false;
      draw();
    }

    // サービスワーカー登録（PWAのオフライン化）
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
